<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <title>–°—Ç–∞—Ç—É—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 520px;
            margin: 40px auto;
        }

        .controls {
            margin-bottom: 12px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        li {
            margin: 6px 0;
        }
    </style>
</head>

<body>

    <h2>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>

    <div class="controls">
        <label>–ü–æ–∫–∞–∑–∞—Ç—å:
            <select id="filterSel">
                <option value="all">–í—Å–µ—Ö</option>
                <option value="on">–¢–æ–ª—å–∫–æ ON</option>
                <option value="off">–¢–æ–ª—å–∫–æ OFF</option>
            </select>
        </label>
        <button id="onAll">–í–∫–ª—é—á–∏—Ç—å –≤—Å–µ—Ö</button>
        <button id="offAll">–í—ã–∫–ª—é—á–∏—Ç—å –≤—Å–µ—Ö</button>
    </div>

    <ul id="list"></ul>

    <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ</h3>
    <form id="addForm">
        <input name="username" placeholder="–ò–º—è" required>
        <button>–î–æ–±–∞–≤–∏—Ç—å</button>
    </form>

    <script>
        const API = 'https://<your-n8n-host>/webhook/authors'; // üëà –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π
        const AUTH = 'Basic ' + btoa('myadmin:s3cret!');        // üëà –ª–æ–≥–∏–Ω:–ø–∞—Ä–æ–ª—å

        const toChecked = s => s === 'on';
        const toStatus = c => c ? 'on' : 'off';
        let usersCache = [];

        function req(method, body) {
            return fetch(API, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': AUTH
                },
                body: body ? JSON.stringify(body) : undefined
            });
        }

        async function load() {
            usersCache = await req('GET').then(r => r.json());
            render();
        }

        function render() {
            const filter = document.getElementById('filterSel').value;
            const list = document.getElementById('list');
            list.innerHTML = '';
            usersCache
                .filter(u => filter === 'all' || u.status === filter)
                .forEach(u => {
                    const li = document.createElement('li');
                    li.innerHTML = `${u.username} <input type="checkbox" ${toChecked(u.status) ? 'checked' : ''}>`;
                    li.querySelector('input').onchange = e =>
                        req('PATCH', { id: u.id, status: toStatus(e.target.checked) }).then(load);
                    list.appendChild(li);
                });
        }

        document.getElementById('addForm').onsubmit = async e => {
            e.preventDefault();
            const username = e.target.username.value.trim();
            if (!username) return;
            await req('POST', { username });
            e.target.reset();
            load();
        };

        document.getElementById('filterSel').onchange = render;

        document.getElementById('onAll').onclick = () => massUpdate('on', '–í–∫–ª—é—á–∏—Ç—å –≤—Å–µ—Ö?');
        document.getElementById('offAll').onclick = () => massUpdate('off', '–í—ã–∫–ª—é—á–∏—Ç—å –≤—Å–µ—Ö?');

        async function massUpdate(state, msg) {
            if (!confirm(msg)) return;
            await req('PATCH', { all: true, status: state });
            load();
        }

        load();
    </script>
</body>

</html>